<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Camera Barcode Scan</title>
<style>
  video { width: 100%; max-width: 400px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h2>Scan Barcode</h2>
<video id="video" autoplay></video>
<p id="status">Initializing...</p>

<script type="module">
import { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat } from 'https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/+esm';
import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';

const supabase = createClient(
  'https://mwsjvglbljyncdrivrtc.supabase.co',
  'sb_publishable_a_U12sK4KRvKiNFbscemOA_hK1_mRAn'
);

const sessionId = new URLSearchParams(window.location.search).get('session') || 'TEST_SESSION';
const video = document.getElementById('video');
const status = document.getElementById('status');

// Only decode DataMatrix to speed up scanner
const hints = new Map();
hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.DATA_MATRIX]);

const codeReader = new BrowserMultiFormatReader(hints);

// Start camera
async function startScanner() {
  try {
    const devices = await BrowserMultiFormatReader.listVideoInputDevices();
    if (devices.length === 0) throw new Error('No camera found');

    const selectedDeviceId = devices[0].deviceId;

    status.innerText = "Camera started. Scanning...";

    codeReader.decodeFromVideoDevice(selectedDeviceId, video, async (result, err) => {
      if (result) {
        status.innerText = "Decoded: " + result.text;

        // Send to Supabase
        await supabase.from('scans').insert({
          session_id: sessionId,
          data: result.text
        });

        // Optional: stop scanner after first successful scan
        codeReader.reset();
        status.innerText = "Scan complete and sent!";
      } else if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err);
      }
    });

  } catch (err) {
    status.innerText = "Error: " + err.message;
    console.error(err);
  }
}

// Start on page load
startScanner();
</script>

</body>
</html>